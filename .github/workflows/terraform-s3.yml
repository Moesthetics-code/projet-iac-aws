name: Terraform S3 Static Website Deployment

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Ce workflow est dÃ©clenchÃ© par l'application Flask via l'API GitHub.
#  Il crÃ©e un bucket S3, configure l'hÃ©bergement web statique, et uploade
#  les fichiers du site.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  workflow_dispatch:
    inputs:
      bucket_name:
        description: 'Nom du bucket S3 (unique globalement)'
        required: true
        type: string

      bucket_env:
        description: 'Environnement de dÃ©ploiement'
        required: true
        type: choice
        options:
          - dev
          - preprod
          - prod

      bucket_region:
        description: 'RÃ©gion AWS'
        required: true
        type: choice
        options:
          - eu-west-3    # Paris
          - eu-north-1   # Stockholm
          - us-east-1    # Virginie du Nord
          - us-west-2    # Oregon

      index_document:
        description: 'Document index du site (ex: index.html)'
        required: true
        type: string
        default: 'index.html'

      error_document:
        description: 'Document 404 (ex: error.html)'
        required: false
        type: string
        default: 'error.html'

      storage_class:
        description: 'Classe de stockage S3'
        required: true
        type: choice
        options:
          - STANDARD
          - STANDARD_IA
          - ONEZONE_IA
          - INTELLIGENT_TIERING

      enable_versioning:
        description: 'Versioning du bucket'
        required: true
        type: choice
        options:
          - Disabled
          - Enabled
          - Suspended

      block_public_acls:
        description: 'Bloquer les ACL publiques (false = site public autorisÃ©)'
        required: true
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

      block_public_policy:
        description: 'Bloquer les politiques publiques (false = GetObject autorisÃ©)'
        required: true
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

      ignore_public_acls:
        description: 'Ignorer les ACL publiques'
        required: true
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

      restrict_public_buckets:
        description: 'Restreindre les buckets publics'
        required: true
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

      file_names:
        description: 'JSON list des noms de fichiers uploadÃ©s (mÃ©tadonnÃ©es)'
        required: false
        type: string
        default: '[]'

# â”€â”€â”€ Variables d'environnement Terraform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  TF_VAR_bucket_name:            ${{ github.event.inputs.bucket_name }}
  TF_VAR_bucket_env:             ${{ github.event.inputs.bucket_env }}
  TF_VAR_region:                 ${{ github.event.inputs.bucket_region }}
  TF_VAR_index_document:         ${{ github.event.inputs.index_document }}
  TF_VAR_error_document:         ${{ github.event.inputs.error_document }}
  TF_VAR_storage_class:          ${{ github.event.inputs.storage_class }}
  TF_VAR_enable_versioning:      ${{ github.event.inputs.enable_versioning }}
  TF_VAR_block_public_acls:      ${{ github.event.inputs.block_public_acls }}
  TF_VAR_block_public_policy:    ${{ github.event.inputs.block_public_policy }}
  TF_VAR_ignore_public_acls:     ${{ github.event.inputs.ignore_public_acls }}
  TF_VAR_restrict_public_buckets: ${{ github.event.inputs.restrict_public_buckets }}

jobs:
  terraform-s3:
    name: 'S3 Static Website Deployment'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./infra

    steps:

    # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout code
      uses: actions/checkout@v4

    # â”€â”€ 2. Configure AWS Credentials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:            ${{ github.event.inputs.bucket_region }}

    # â”€â”€ 3. Verify AWS Credentials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Verify AWS Credentials
      run: |
        aws sts get-caller-identity
        echo "âœ… Credentials AWS configurÃ©s avec succÃ¨s"
        echo "ðŸ“ RÃ©gion cible: ${{ github.event.inputs.bucket_region }}"

    # â”€â”€ 4. Setup Terraform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.8.5

    # â”€â”€ 5. Prepare site directory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Cette Ã©tape simule les fichiers du site. En production, vous rÃ©cupÃ©reriez
    # les fichiers depuis un artifact, un autre repo, ou un bucket S3 source.
    - name: Prepare site directory
      run: |
        mkdir -p ./site
        echo "âš ï¸ RÃ©pertoire ./site crÃ©Ã©."
        echo "En production, copiez vos fichiers dans ./site avant cette Ã©tape."
        echo "Exemple: cp -r ../my-website/* ./site/"

        # CrÃ©er un fichier de dÃ©monstration si le dossier est vide
        if [ -z "$(ls -A ./site 2>/dev/null)" ]; then
          echo "CrÃ©ation d'une page de dÃ©monstration..."
          cat > ./site/index.html << 'EOF'
        <!DOCTYPE html>
        <html><head><meta charset="UTF-8"><title>SONATEL IAC â€” S3</title></head>
        <body style="font-family:sans-serif;text-align:center;padding:60px;background:#060d1f;color:#f8fafc">
          <h1>ðŸª£ Site dÃ©ployÃ© via Terraform + GitHub Actions</h1>
          <p>Projet IAC SONATEL â€” S3 Static Website Deployer</p>
        </body></html>
        EOF
          cat > ./site/error.html << 'EOF'
        <!DOCTYPE html>
        <html><head><meta charset="UTF-8"><title>404 â€” SONATEL IAC</title></head>
        <body style="font-family:sans-serif;text-align:center;padding:60px;background:#060d1f;color:#f8fafc">
          <h1>404</h1><p>Page non trouvÃ©e</p>
        </body></html>
        EOF
          echo "âœ… Fichiers de dÃ©monstration crÃ©Ã©s"
        fi

        echo "ðŸ“‚ Fichiers dans ./site:"
        ls -la ./site/

    # â”€â”€ 6. Terraform Format Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform Format Check
      run: terraform fmt -recursive -check
      continue-on-error: true

    # â”€â”€ 7. Remove Lock File â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Remove Terraform Lock File
      run: rm -f .terraform.lock.hcl
      continue-on-error: true

    # â”€â”€ 8. Terraform Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform Init
      run: |
        echo "ðŸ”§ Initialisation de Terraform..."
        terraform init -upgrade
        echo "âœ… Terraform initialisÃ©"

    # â”€â”€ 9. Terraform Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform Validate
      run: |
        terraform validate
        echo "âœ… Configuration Terraform valide"

    # â”€â”€ 10. Terraform Plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform Plan
      run: |
        echo "ðŸ“‹ GÃ©nÃ©ration du plan Terraform..."
        echo "ðŸª£  Bucket: ${{ github.event.inputs.bucket_name }}"
        echo "ðŸŒ  RÃ©gion: ${{ github.event.inputs.bucket_region }}"
        echo "ðŸ·ï¸  Env   : ${{ github.event.inputs.bucket_env }}"
        echo "ðŸ”“  AccÃ¨s public: block_public_acls=false, block_public_policy=false"
        echo ""
        terraform plan -out=tfplan -no-color
        echo ""
        echo "ðŸ“‹ RÃ©sumÃ© du plan:"
        terraform show -no-color tfplan

    # â”€â”€ 11. Upload Plan Artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Upload Plan
      uses: actions/upload-artifact@v4
      with:
        name: terraform-s3-plan
        path: infra/tfplan
        retention-days: 1

    # â”€â”€ 12. Terraform Apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform Apply
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "ðŸš€ Application de la configuration Terraform..."
        terraform apply -auto-approve tfplan
        echo ""
        echo "âœ… Infrastructure S3 dÃ©ployÃ©e avec succÃ¨s!"

    # â”€â”€ 13. Terraform Output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Terraform Output
      if: success()
      run: |
        echo "ðŸ“Š Outputs de l'infrastructure:"
        echo "================================"
        terraform output -json > outputs.json
        terraform output
        echo ""
        echo "ðŸŒ URL du site web:"
        terraform output website_url

    # â”€â”€ 14. Upload Outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Upload Outputs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: terraform-s3-outputs
        path: infra/outputs.json
        retention-days: 7

    # â”€â”€ 15. Test Endpoint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Test Website Endpoint
      if: success()
      run: |
        ENDPOINT=$(terraform output -raw website_endpoint)
        echo "ðŸ§ª Test de l'endpoint: http://$ENDPOINT"
        sleep 5  # DÃ©lai pour la propagation
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$ENDPOINT" || echo "000")
        echo "Code HTTP: $HTTP_CODE"
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Site web accessible publiquement"
        else
          echo "âš ï¸ Code HTTP: $HTTP_CODE (la propagation DNS peut prendre quelques secondes)"
        fi

    # â”€â”€ 16. Deployment Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸª£ DÃ©ploiement S3 rÃ©ussi!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Configuration du Bucket:" >> $GITHUB_STEP_SUMMARY
        echo "| ParamÃ¨tre | Valeur |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Nom** | \`${{ github.event.inputs.bucket_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **RÃ©gion** | ${{ github.event.inputs.bucket_region }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Environnement** | ${{ github.event.inputs.bucket_env }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Storage Class** | ${{ github.event.inputs.storage_class }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Versioning** | ${{ github.event.inputs.enable_versioning }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Index Document** | \`${{ github.event.inputs.index_document }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”“ AccÃ¨s Public:" >> $GITHUB_STEP_SUMMARY
        echo "| Option | Valeur |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| block_public_acls | ${{ github.event.inputs.block_public_acls }} |" >> $GITHUB_STEP_SUMMARY
        echo "| block_public_policy | ${{ github.event.inputs.block_public_policy }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ignore_public_acls | ${{ github.event.inputs.ignore_public_acls }} |" >> $GITHUB_STEP_SUMMARY
        echo "| restrict_public_buckets | ${{ github.event.inputs.restrict_public_buckets }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Terraform Outputs:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        terraform output >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
